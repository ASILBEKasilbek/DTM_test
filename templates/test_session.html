{% extends 'base.html' %}
{% load static %}
{% load math_filters %}

{% block title %}{{ session.subject.name }} Testi{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-3">{{ session.subject.name }} Testi</h2>

    {% if error %}
        <div class="alert alert-danger" role="alert">
            {{ error }}
        </div>
        <a href="{% url 'app:home' %}" class="btn btn-primary">Bosh sahifaga qaytish</a>
    {% else %}
        <div class="progress mb-3">
            <div class="progress-bar" role="progressbar"
                style="width: {{ current_index|div:total_questions|mul:100|floatformat:0 }}%;"
                aria-valuenow="{{ current_index }}" aria-valuemin="1" aria-valuemax="{{ total_questions }}">
                {{ current_index }} / {{ total_questions }}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5>Savol {{ current_index }} / {{ total_questions }}</h5>
            </div>
            <div class="card-body">
                <p class="card-text">{{ question.text }}</p>

                {% if question.image %}
                    <img src="{{ question.image.url }}" alt="Savol rasmi" class="img-fluid mb-3" style="max-width: 300px;">
                {% endif %}

                <form id="answer-form" action="{% url 'app:save_answer' session_id=session.id question_id=question.id %}" method="POST">
                    {% csrf_token %}
                    {% for option in options %}
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="answer_id" id="option_{{ option.id }}" 
                                   value="{{ option.id }}" required>
                            <label class="form-check-label" for="option_{{ option.id }}">
                                {{ option.label }}. {{ option.text }}
                            </label>
                        </div>
                    {% empty %}
                        <div class="alert alert-warning">Bu savol uchun variantlar mavjud emas.</div>
                    {% endfor %}

                    <button type="submit" class="btn btn-primary mt-3" disabled>Javobni saqlash</button>
                </form>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if not error %}
<script src="{% static 'js/test.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("answer-form");
        const submitBtn = form.querySelector("button[type='submit']");
        const radios = form.querySelectorAll("input[name='answer_id']");

        radios.forEach(radio => {
            radio.addEventListener("change", () => {
                submitBtn.disabled = false;
            });
        });

        form.addEventListener("submit", function (e) {
            e.preventDefault();

            fetch(form.action, {
                method: "POST",
                headers: {
                    "X-CSRFToken": form.querySelector("[name='csrfmiddlewaretoken']").value,
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams(new FormData(form))
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    window.location.reload();  // Keyingi savol
                } else {
                    alert("Xatolik: " + (data.message || "Javob saqlanmadi."));
                }
            })
            .catch(error => {
                alert("Xatolik yuz berdi: " + error);
            });
        });
    });
</script>
{% endif %}
{% endblock %}
